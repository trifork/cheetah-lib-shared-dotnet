<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Using Cheetah.OpenSearch | Cheetah Nuget Packages </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Using Cheetah.OpenSearch | Cheetah Nuget Packages ">
      
      
      <link rel="icon" href="../../favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="../../toc.html">
      
      
      
      
      <meta name="docfx:docurl" content="https://github.com/KastTrifork/cheetah-lib-shared-dotnet/blob/main/docs/articles/Cheetah.OpenSearch/UsingCheetahOpenSearch.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../logo.svg" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="using-cheetahopensearch">Using Cheetah.OpenSearch</h1>

<p>The primary purpose of Cheetah.OpenSearch is to simplify the registration and configuration of OpenSearch clients for use with the Cheetah data platform.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>Basic understanding of OpenSearch and the <a href="https://opensearch.org/docs/latest/clients/OSC-dot-net/">high-level OpenSearch .NET client</a></li>
</ul>
<h2 id="getting-started">Getting Started</h2>
<p>In an .NET application with some sort of <code>HostBuilder</code> startup, all you need to get started is the following line in your <code>Program.cs</code>:</p>
<pre><code class="lang-csharp">builder.Services.AddCheetahOpenSearch(builder.Configuration);
</code></pre>
<p>This will make an <code>IOpenSearchClient</code> available for dependency injection in other services like in this API Controller which has an endpoint that retrieves the names of all indexes that follow a specific index pattern:</p>
<pre><code class="lang-csharp">[ApiController]
[Route(&quot;[controller]&quot;)]
public class IndexController : ControllerBase
{
    readonly IOpenSearchClient _client;
    public IndexController(IOpenSearchClient client)
    {
        _client = client;
    }

    [HttpGet(&quot;indices/{indexPattern}&quot;)]
    public async Task&lt;IActionResult&gt; GetIndices([FromRoute] string indexPattern)
    {
        var response = await _client.Indices.GetAsync(indexPattern);
        var indexNames = response.Indices.Select(x =&gt; x.Key.Name);
        return Ok(indexNames);
    }
}
</code></pre>
<h2 id="configuration">Configuration</h2>
<p>In order for Cheetah.OpenSearch to work, you must provide the following configuration:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Description</th>
<th>Example</th>
<th>Required</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OpenSearch:Url</code></td>
<td>The url to OpenSearch.</td>
<td><code>http://opensearch:9200</code></td>
<td>✓</td>
</tr>
<tr>
<td><code>OpenSearch:AuthMode</code></td>
<td>The authentication method to use. Valid values: <code>None</code>, <code>Basic</code>, <code>OAuth2</code>. Default: <code>Basic</code></td>
<td><code>OAuth2</code></td>
<td></td>
</tr>
<tr>
<td><code>OpenSearch:UserName</code></td>
<td>The username to use when authenticating using <code>Basic</code> authentication.</td>
<td><code>admin</code></td>
<td>When <code>AuthMode=Basic</code></td>
</tr>
<tr>
<td><code>OpenSearch:Password</code></td>
<td>The password to use when authenticating using <code>Basic</code> authentication.</td>
<td><code>p4$$w0rD</code></td>
<td>When <code>AuthMode=Basic</code></td>
</tr>
<tr>
<td><code>OpenSearch:OAuth2:TokenEndpoint</code></td>
<td>The endpoint to retrieve tokens from when using <code>OAuth2</code> authentication.</td>
<td><code>http://keycloak:1852/realms/local-development/protocol/openid-connect/token</code></td>
<td>When <code>AuthMode=OAuth2</code></td>
</tr>
<tr>
<td><code>OpenSearch:OAuth2:ClientId</code></td>
<td>The client id to retrieve tokens for when using <code>OAuth2</code> authentication.</td>
<td><code>default-access</code></td>
<td>When <code>AuthMode=OAuth2</code></td>
</tr>
<tr>
<td><code>OpenSearch:OAuth2:ClientSecret</code></td>
<td>The client secret to use when retrieving tokens for <code>OAuth2</code> authentication.</td>
<td><code>default-access-secret</code></td>
<td>When <code>AuthMode=OAuth2</code></td>
</tr>
<tr>
<td><code>OpenSearch:OAuth2:Scope</code></td>
<td>The scope to request when retrieving tokens for <code>OAuth2</code> authentication.</td>
<td><code>opensearch</code></td>
<td>When <code>AuthMode=OAuth2</code></td>
</tr>
<tr>
<td><code>OpenSearch:OAuth2:ClockSkewSeconds</code></td>
<td>The number of seconds of clock skew to allow for when validating <code>OAuth2</code> tokens. Default: <code>300</code></td>
<td><code>300</code></td>
<td></td>
</tr>
<tr>
<td><code>OpenSearch:DisableTlsValidation</code></td>
<td>Whether or not to disable TLS validation towards OpenSearch. Default: <code>false</code></td>
<td><code>true</code></td>
<td></td>
</tr>
<tr>
<td><code>OpenSearch:CaCertificatePath</code></td>
<td>The path to the CA certificate used to validate OpenSearch's certificate.</td>
<td><code>/path/to/my/cert.pem</code></td>
<td></td>
</tr>
</tbody>
</table>
<p>The below example configuration can be placed in an <code>appsettings.json</code> to supply the necessary keys in development. These should be supplied through environment variables when running through docker-compose or in cluster.</p>
<pre><code class="lang-json">&quot;OpenSearch&quot;: {
    &quot;Url&quot;: &quot;http://opensearch:9200&quot;,
    &quot;AuthMode&quot;: &quot;OAuth2&quot;,
    &quot;OAuth2&quot;:{
        &quot;ClientId&quot;: &quot;default-access&quot;,
        &quot;ClientSecret&quot;: &quot;default-access-secret&quot;,
        &quot;TokenEndpoint&quot;: &quot;http://keycloak:1852/realms/local-development/protocol/openid-connect/token&quot;,
        &quot;Scope&quot;: &quot;opensearch&quot;
    }
}
</code></pre>
<h2 id="modifying-client-behavior">Modifying client behavior</h2>
<p>It is possible to modify the registered client's behavior through its options, which in the snippet below is used to modify the serialization behavior of the client, and disabling direct streming, when in a development environment:</p>
<pre><code class="lang-csharp">builder.Services.AddCheetahOpenSearch(builder.Configuration, cfg =&gt;
{
    if (hostEnvironment.IsDevelopment()) {
        cfg.WithConnectionSettings(settings =&gt; {
            settings.DisableDirectStreaming();
        });
    }
    cfg.WithJsonSerializerSettings(settings =&gt; {
        settings.MissingMemberHandling = MissingMemberHandling.Error;
        settings.Converters.Add(new UtcDateTimeConverter());
    });
});
</code></pre>
<p>This specifies that the serialization should throw when a missing member is encountered and that it should add a custom converter for handling DateTimes.</p>
<p>The <code>UtcDateTimeConverter</code> comes as part of <code>Cheetah.Kafka</code> and makes it possible for the client to serialize epoch millis timestamps into DateTimes and vice-versa. It was previously a built-in converter in <code>Cheetah.Shared.WebApi</code>, which means that if you're migrating from there, you might need to manually add this converter like in the snippet above.</p>

</article>


        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>


    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
