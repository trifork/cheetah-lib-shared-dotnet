name: Create and publish skagerak.shared nuget package

on:
  workflow_dispatch:

  push:
    branches: ["main"]
    tags:
      - "v*"

env:
  PROJECT_PATH: ./Skagerak.WebApi.Shared/Skagerak.WebApi.Shared.csproj

jobs:
  build-and-push-nuget:
    runs-on: ubuntu-latest
    if: "!startsWith(github.ref, 'refs/tags/v')"
    steps:
      - name: "Checkout"
        uses: actions/checkout@v3
      - name: "Setup .Net Core SDK 6.0"
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: "6.0"
      - name: "Dotnet build"
        run: dotnet build --configuration Release ${{ env.PROJECT_PATH}}
      - name: "Test"
        run: dotnet test --no-restore --verbosity normal ${{ env.PROJECT_PATH}}
      - name: "create output-folder"
        run: mkdir -p output
      - name: Get Tag-name
        id: vars
        run: echo ::set-output name=tag::${GITHUB_REF#refs/*/v}
      - name: "package"
        run: dotnet pack --version-suffix ${{ github.run_number }} -o output -c Release ${{ env.PROJECT_PATH}} #/p:PackageVersion=${{ steps.vars.outputs.tag }}
     # - name: "Prep Source"
      #  run: dotnet nuget add Source --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/trifork/index.json"
      #- name: "Publish to github packages"
       # run: dotnet nuget push output/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source "github"
