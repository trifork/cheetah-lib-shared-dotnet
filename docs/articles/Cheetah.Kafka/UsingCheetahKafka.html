<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Using Cheetah.Kafka | Cheetah Nuget Packages </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Using Cheetah.Kafka | Cheetah Nuget Packages ">
      
      
      <link rel="icon" href="../../favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="../../toc.html">
      
      
      
      
      <meta name="docfx:docurl" content="https://github.com/trifork/cheetah-lib-shared-dotnet/blob/main/docs/articles/Cheetah.Kafka/UsingCheetahKafka.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../logo.svg" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="using-cheetahkafka">Using Cheetah.Kafka</h1>

<p><code>Cheetah.Kafka</code> primary purpose is to bootstrap and configure Kafka clients and make them available for dependency injection.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>Basic understanding of Kafka and <a href="https://docs.confluent.io/kafka-clients/dotnet/current/overview.html">the Apache Kafka .NET Client</a></li>
</ul>
<h2 id="getting-started">Getting started</h2>
<p>In an .NET application with some sort of <code>HostBuilder</code> startup, all you need to get started is the following lines in your <code>Program.cs</code>:
The snippet below will add Kafka's required dependencies and then register a pre-configured <code>IConsumer&lt;ExampleKeyModel, ExampleValueModel&gt;</code> for dependency injection:</p>
<pre><code class="lang-csharp">builder.Services
    .AddCheetahKafka(builder.Configuration)
    .WithConsumer&lt;ExampleKeyModel, ExampleValueModel&gt;();
</code></pre>
<p>This will add necessary dependencies and register an <code>IConsumer&lt;ExampleKeyModel, ExampleValueModel&gt;</code>, where <code>ExampleKeyModel</code> and <code>ExampleValueModel</code> are the key and value types of consumed messages.</p>
<p>This consumer can then be injected into other services like so:</p>
<pre><code class="lang-csharp">public class MyService {
    private readonly IConsumer&lt;ExampleKeyModel, ExampleValueModel&gt; _consumer;

    public MyService(IConsumer&lt;ExampleKeyModel, ExampleValueModel&gt; consumer)
    {
        _consumer = consumer;
    }
}
</code></pre>
<p>The injected consumer is pre-configured to:</p>
<ul>
<li>Authenticate towards Kafka using OAuth2</li>
<li>Deserialize message values and keys from json with UTF8-encoding.</li>
</ul>
<p>The same concept applies for producers and admin clients. The following example shows a producer and admin client being registered and injected:</p>
<pre><code class="lang-csharp">// in Program.cs
builder.Services.AddCheetahKafka(builder.Configuration)
    .WithProducer&lt;string, ExampleModel&gt;()
    .WithAdminClient();

// in MyService.cs
public class MyService {
    private readonly IProducer&lt;string, ExampleModel&gt; _producer;
    private readonly IAdminClient _adminClient;

    public MyService(IProducer&lt;string, ExampleModel&gt; producer, IAdminClient adminClient){
        _producer = producer;
        _adminClient = adminClient;
    }
}
</code></pre>
<h2 id="configuration">Configuration</h2>
<p>You'll need to provide the following configuration to use <code>Cheetah.Kafka</code>:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Description</th>
<th>Example</th>
<th>Required</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Kafka__Url</code></td>
<td>The url to kafka. Must <em>not</em> include a scheme prefix.</td>
<td><code>kafka:19092</code></td>
<td>✓</td>
</tr>
<tr>
<td><code>Kafka__SecurityProtocol</code></td>
<td>Security protocol used to connect to Kafka.</td>
<td><code>SaslPlaintext</code></td>
<td></td>
</tr>
<tr>
<td><code>Kafka__SaslMechanism</code></td>
<td>Sasl mechanism used to authenticate towards Kafka.</td>
<td><code>OAuthBearer</code></td>
<td></td>
</tr>
<tr>
<td><code>Kafka__OAuth2__ClientId</code></td>
<td>The Client Id to use when retrieving tokens using OAuth2</td>
<td><code>default-access</code></td>
<td>When <code>SaslMechanism=OAuthBearer</code></td>
</tr>
<tr>
<td><code>Kafka__OAuth2__ClientSecret</code></td>
<td>The Client Secret to use when retrieving tokens using OAuth2</td>
<td><code>default-access-secret</code></td>
<td>When <code>SaslMechanism=OAuthBearer</code></td>
</tr>
<tr>
<td><code>Kafka__OAuth2__TokenEndpoint</code></td>
<td>The endpoint where tokens should be retrieved from</td>
<td><code>http://keycloak:1852/realms/local-development/protocol/openid-connect/token</code></td>
<td>When <code>SaslMechanism=OAuthBearer</code></td>
</tr>
<tr>
<td><code>Kafka__OAuth2__Scope</code></td>
<td>The scope that the requested token should have</td>
<td><code>kafka</code></td>
<td>When <code>SaslMechanism=OAuthBearer</code></td>
</tr>
</tbody>
</table>
<p>The below example configuration can be placed in an <code>appsettings.json</code> to supply the necessary keys in development. These should be supplied through environment variables when running through docker-compose or in cluster.</p>
<pre><code class="lang-json">&quot;Kafka&quot;: {
    &quot;Url&quot;: &quot;kafka:19092&quot;,
    &quot;SecurityProtocol&quot;: &quot;SaslPlaintext&quot;,
    &quot;SaslMechanism&quot;: &quot;OAuthBearer&quot;,
    &quot;OAuth2&quot;:{
        &quot;ClientId&quot;: &quot;default-access&quot;,
        &quot;ClientSecret&quot;: &quot;default-access-secret&quot;,
        &quot;TokenEndpoint&quot;: &quot;http://keycloak:1852/realms/local-development/protocol/openid-connect/token&quot;,
        &quot;Scope&quot;: &quot;kafka&quot; 
    }
}
</code></pre>
<h2 id="configuring-client-behavior">Configuring client behavior</h2>
<p>It is possible to configure client behavior both generally for all clients, for specific types of clients and for individual clients.</p>
<p>The default configuration used by generated clients can be modified when calling <code>AddCheetahKafka</code>, while the configuration for individual clients can be modified when the client is registered.</p>
<p>The snippet below shows configuration of all clients to allow auto-creation of topics, specifies that all created consumers should be in the <code>my-group</code> consumer group, and then registers two consumers, one of which is explicitly told to use the <code>the-group</code> consumer group and to serialize the key into a string type using the Confluent Kafka Utf8 Deserializer instead of the default json deserializer.</p>
<pre><code class="lang-csharp">[...]
using Confluent.Kafka;

[...]

builder.Services.AddCheetahKafka(builder.Configuration, options =&gt; 
    {
        options.ConfigureDefaultClient(config =&gt; {
            config.AllowAutoCreateTopics = true;
        });
        options.ConfigureDefaultConsumer(config =&gt; {
            config.GroupId = &quot;my-group&quot;;
        });
    })
    .WithConsumer&lt;string, ExampleModel&gt;(options =&gt; {
        options.SetKeyDeserializer(sp =&gt; Deserializers.Utf8);
        options.ConfigureClient(cfg =&gt;
        {
            cfg.GroupId = &quot;the-group&quot;;
        });
    })
    .WithConsumer&lt;KeyModel, OtherModel&gt;();
</code></pre>
<p>From here, one would be able to inject <code>IConsumer&lt;string, ExampleModel&gt;</code> and <code>IConsumer&lt;KeyModel, OtherModel&gt;</code> in other services. The same configuration is possible for producers and admin clients.</p>
<h2 id="multiple-clients-with-the-same-signature">Multiple clients with the same signature</h2>
<p>In some scenarios, you want multiple clients with the same signature (e.g. <code>IProducer&lt;string, ExampleModel&gt;</code>), but with different configurations.</p>
<p>While it is possible to register a given producer type multiple times by repeatedly calling <code>WithProducer</code> and inject them all using <code>IEnumerable&lt;IProducer&lt;TKey, TValue&gt;&gt;</code>, it is usually necessary to be able to differentiate differently configured producers.</p>
<p>This can be resolved by using <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-8.0#keyed-services">.NET's Keyed Services</a>. The below example registers two different producers with different batch sizes, each with a different key:</p>
<pre><code class="lang-csharp">builder.Services.AddCheetahKafka(builder.Configuration)
    .WithKeyedProducer&lt;string, ExampleModel&gt;(&quot;BigBatch&quot;, cfg =&gt; {
        cfg.BatchSize = 9001;
    })
    .WithKeyedProducer&lt;string, ExampleModel&gt;(&quot;SmallBatch&quot;, cfg =&gt; {
        cfg.BatchSize = 100;
    });
</code></pre>
<p>These can then be injected into a service using the <code>[FromKeyedServices]</code> attribute:</p>
<pre><code class="lang-csharp">public class MyService {
    private readonly IProducer&lt;string, ExampleModel&gt; _bigBatchProducer;
    private readonly IProducer&lt;string, ExampleModel&gt; _smallBatchProducer;

    public MyService(
        [FromKeyedServices(&quot;BigBatch&quot;)] IProducer&lt;string, ExampleModel&gt; bigBatchProducer,
        [FromKeyedServices(&quot;SmallBatch&quot;)] IProducer&lt;string, ExampleModel&gt; smallBatchProducer){
            _bigBatchProducer = bigBatchProducer;
            _smallBatchProducer = smallBatchProducer;
        }
}
</code></pre>
<h2 id="using-kafkaclientfactory">Using KafkaClientFactory</h2>
<div class="NOTE">
<h5>Note</h5>
<p>The following method of using the package is both possible and valid, but makes it the reader's responsibility to handle client lifetimes and individual client configuration</p>
<p>We recommend registering and configuring clients using the methods described in the previous sections.</p>
</div>
<p>Internally, the package uses a <code>KafkaClientFactory</code> to create the clients that get registered. This factory can be dependency injected into order services to create clients without injecting them directly:</p>
<pre><code class="lang-csharp">// In Program.cs
builder.Services.AddCheetahKafka(builder.Configuration);

// In MyService.cs
public class MyService {
    private readonly KafkaClientFactory _factory;

    public MyService(KafkaClientFactory factory){
        _factory = factory;
    }

    public void PublishMessage&lt;TKey, TValue&gt;(TKey key, TValue message, string topicName){
        var producer = _factory.CreateProducer&lt;TKey, TValue&gt;();
        producer.Produce(topicName, new Message&lt;TKey, TValue&gt; { Key = key, Value = message });
    }
}
</code></pre>
<p>The above snippet uses the KafkaClientFactory and essentially enables MyService to publish any type of Message.</p>
<p>Bear in mind that creating and disposing producers this often is not generally recommended and that the above example is primarily to showcase what <em>can</em> be done and not what <em>should</em> be done.</p>

</article>


        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>


    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
